<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Display Rules & Collections</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="design_system.css">
    <link rel="stylesheet" href="modern_styles.css">
    
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/7.22.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.22.1/firebase-firestore.js"></script>

    <!-- IndexedDB Setup -->
    <script src="setupIndexedDB.js"></script>
    <script src="GenerateRule.js"></script>
    
    <style>
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 8px;
        }
        .rule-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .rule-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .rule-card.group-rule {
            border-left: 4px solid #ffc107;
        }
        .rule-card.display-rule {
            border-left: 4px solid #007bff;
        }
        .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .rule-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }
        .rule-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .rule-content {
            color: #444;
            margin-bottom: 1rem;
        }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .badge-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .badge-group {
            background: #fff3cd;
            color: #856404;
        }
        .badge-display {
            background: #d1ecf1;
            color: #0c5460;
        }
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 2rem 0;
        }
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        .filter-bar {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-back {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
        
        <a href="index.html" class="nav-back btn btn-outline-secondary">
            ‚Üê Back to Main Menu
        </a>

        <div class="page-header">
            <h1 style="margin: 0 0 0.5rem 0;">üìã Manage Display Rules & Collections</h1>
            <p style="margin: 0; opacity: 0.9;">Create, view, and manage your display rules and rule collections</p>
        </div>

        <div class="filter-bar">
            <div class="row">
                <div class="col-12">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px;">
                            <input type="text" id="searchInput" class="form-control" placeholder="üîç Search by Author, ID, or Title..." oninput="filterRules()">
                            <small id="searchStatus" style="color: #666; display: block; margin-top: 0.25rem;">Ready to search...</small>
                        </div>
                        <div>
                            <select id="typeFilter" class="form-control" onchange="filterRules()" style="min-width: 200px;">
                                <option value="all">All Types</option>
                                <option value="display">Display Rules Only</option>
                                <option value="collection">Collections Only</option>
                            </select>
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="refreshList()">üîÑ Refresh</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
            <button class="btn btn-danger" onclick="window.location.href='addNewRule.html'" style="flex: 1;">
                ‚ûï New Display Rule
            </button>
            <button class="btn btn-warning" onclick="createNewCollection()" style="flex: 1;">
                ‚ûï New Rule Collection
            </button>
        </div>

        <div style="display: flex; gap: 1rem; margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
            <button class="btn btn-outline-primary" onclick="window.location.href='ManageCollections.html'" style="flex: 1;">
                üì¶ View Collections Only
            </button>
            <button class="btn btn-outline-secondary" onclick="window.location.href='ManageAuthors.html'" style="flex: 1;">
                üë§ Manage Authors
            </button>
            <button class="btn btn-outline-info" onclick="window.location.href='GroupRuleDemo.html'" target="_blank" style="flex: 1;">
                üìä Test Logic Demo
            </button>
        </div>

        <div id="rulesContainer">
            <!-- Rules will be loaded here -->
        </div>

        <div id="emptyState" class="empty-state hidealways">
            <div class="empty-state-icon">üì≠</div>
            <h3>No Rules Found</h3>
            <p style="color: #666; margin-bottom: 1.5rem;">Your database is empty. You need to create some Display Rules or Collections.</p>
            
            <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1.5rem;">
                <button class="btn btn-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem 2rem; font-size: 1.1rem; font-weight: bold;" onclick="createSampleData()">
                    üì¶ Load Sample Data
                </button>
                <button class="btn btn-lg btn-outline-danger" style="padding: 1rem 2rem; font-size: 1.1rem; font-weight: bold;" onclick="clearAllData()">
                    üóëÔ∏è Clear All Data
                </button>
            </div>
            
            <p style="color: #999; font-size: 0.9rem;">Sample data includes 20 authors, 25 display rules, and 21 collections</p>
            
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #ddd;">
                <p style="color: #666; margin-bottom: 1rem;">Or create your own:</p>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn btn-primary" onclick="window.location.href='addNewRule.html'">Create Display Rule</button>
                    <button class="btn btn-warning" onclick="createNewCollection()">Create Collection</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        let allRules = [];

        // Load rules when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log("ManageRules.html loaded, initializing...");
            console.log("Checking if setupIndexedDB exists:", typeof setupIndexedDB);
            
            // Give setupIndexedDB.js time to initialize the database
            setTimeout(() => {
                console.log("Starting to load rules after database initialization...");
                loadAllRules();
            }, 500);
        });

        function loadAllRules() {
            console.log("=== LOADING ALL RULES ===");
            console.log("Loading all rules from IndexedDB...");
            const database = "authorExcuTrust";
            
            // First, check if IndexedDB is available
            if (!window.indexedDB) {
                console.error("IndexedDB not supported!");
                showEmptyState("Your browser doesn't support IndexedDB");
                return;
            }
            
            console.log("Opening database:", database);
            const databaseOpenRequest = indexedDB.open(database);
            
            databaseOpenRequest.onerror = (event) => {
                console.error("Database open error:", event);
                console.error("Error details:", event.target.error);
                showEmptyState("Error loading database: " + event.target.error);
            };
            
            databaseOpenRequest.onupgradeneeded = (event) => {
                console.log("Database upgrade needed - this might be first time opening");
                // Let setupIndexedDB.js handle the upgrade
            };
            
            databaseOpenRequest.onsuccess = () => {
                const db = databaseOpenRequest.result;
                console.log("‚úì Database opened successfully");
                console.log("Database name:", db.name);
                console.log("Database version:", db.version);
                console.log("Available stores:", Array.from(db.objectStoreNames));
                
                // Check if ruleStore exists
                if (!db.objectStoreNames.contains('ruleStore')) {
                    console.error("ruleStore does not exist in database!");
                    showEmptyState("Database not properly initialized. Please refresh the page.");
                    db.close();
                    return;
                }
                
                console.log("Opening transaction on ruleStore...");
                const tx = db.transaction("ruleStore", "readonly");
                const store = tx.objectStore("ruleStore");
                
                console.log("Getting all records from ruleStore...");
                const getAllRequest = store.getAll();
                
                getAllRequest.onsuccess = () => {
                    allRules = getAllRequest.result || [];
                    console.log(`‚úì Loaded ${allRules.length} rules from database`);
                    
                    // Debug: Show detailed info about each rule
                    if (allRules.length > 0) {
                        console.log("=== ALL RULES IN DATABASE ===");
                        allRules.forEach((rule, index) => {
                            console.log(`Rule ${index + 1}:`, {
                                type: rule.keyPathValue[0],
                                author: rule.keyPathValue[2],
                                id: rule.keyPathValue[4],
                                content: rule.keyPathValue[0] === 'groupruleStore' ? rule.groupruleContent : rule.ruleContent
                            });
                        });
                        console.log("============================");
                    } else {
                        console.warn("‚ö†Ô∏è No rules found in database!");
                        console.log("Database appears to be empty. You need to create rules first.");
                        console.log("Click the 'Create Sample Data' button to add test data.");
                        
                        // Auto-prompt to create sample data
                        setTimeout(() => {
                            if (confirm("Database is empty!\n\nWould you like to create sample data now?\n\n‚Ä¢ 2 Display Rules\n‚Ä¢ 1 Rule Collection\n‚Ä¢ All with Author: JSM")) {
                                createSampleData();
                            }
                        }, 1000);
                    }
                    
                    displayRules(allRules);
                    db.close();
                };
                
                getAllRequest.onerror = (event) => {
                    console.error("Error getting rules:", event);
                    console.error("Error details:", event.target.error);
                    showEmptyState("Error loading rules: " + event.target.error);
                    db.close();
                };
            };
            
            console.log("Database open request initiated...");
        }

        function displayRules(rules) {
            const container = document.getElementById('rulesContainer');
            const emptyState = document.getElementById('emptyState');
            
            console.log(`Displaying ${rules.length} rules`);
            
            // Always clear container first
            container.innerHTML = '';
            
            if (!rules || rules.length === 0) {
                emptyState.classList.remove('hidealways');
                
                // Show debug info about database
                const database = "authorExcuTrust";
                const databaseOpenRequest = indexedDB.open(database);
                databaseOpenRequest.onsuccess = () => {
                    const db = databaseOpenRequest.result;
                    console.log("Database name:", db.name);
                    console.log("Database version:", db.version);
                    console.log("Object stores:", Array.from(db.objectStoreNames));
                    db.close();
                };
                
                return;
            }
            
            // Hide empty state
            emptyState.classList.add('hidealways');
            
            // Extract unique authors for debugging
            const authors = [...new Set(rules.map(r => r.keyPathValue[2]))];
            console.log("Available authors:", authors);
            
            // Show summary at top
            const summary = document.createElement('div');
            summary.style.cssText = 'background: #e7f3ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;';
            summary.innerHTML = `
                <strong>üìä Summary:</strong> ${rules.length} rule(s) found | 
                <strong>Authors:</strong> ${authors.join(', ')}
            `;
            container.appendChild(summary);
            
            rules.forEach(rule => {
                const card = createRuleCard(rule);
                container.appendChild(card);
            });
        }

        function createRuleCard(rule) {
            const div = document.createElement('div');
            const isGroupRule = rule.keyPathValue[0] === 'groupruleStore';
            const isDisplayRule = rule.keyPathValue[0] === 'trueruleStore';
            
            div.className = `rule-card ${isGroupRule ? 'group-rule' : 'display-rule'}`;
            
            const author = rule.keyPathValue[2] || 'Unknown';
            const id = rule.keyPathValue[4] || 'Unknown';
            const content = isGroupRule ? (rule.groupruleContent || 'No title') : (rule.ruleContent || 'No description');
            const type = isGroupRule ? 'Rule Collection' : 'Display Rule';
            const badgeClass = isGroupRule ? 'badge-group' : 'badge-display';
            
            // Get logic type info for group rules
            let logicInfo = '';
            if (isGroupRule) {
                const logicType = rule.ruleLogicType || (rule.all0Any1True ? 'any' : 'all');
                let logicText = '';
                switch(logicType) {
                    case 'all': logicText = 'ALL rules must be true'; break;
                    case 'any': logicText = 'ANY rule must be true'; break;
                    case 'count': logicText = `At least ${rule.minRuleCount || 1} rules must be true`; break;
                    case 'percent': logicText = `At least ${rule.minRulePercent || 50}% of rules must be true`; break;
                }
                const numRules = rule.allRowChoices ? rule.allRowChoices.length : 0;
                logicInfo = `<div class="rule-meta">üìä Logic: ${logicText} | Contains: ${numRules} rule(s)</div>`;
            }
            
            div.innerHTML = `
                <div class="rule-header">
                    <span class="badge-type ${badgeClass}">${type}</span>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary" onclick='editRule(${JSON.stringify(rule.keyPathValue)})'>
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick='viewRule(${JSON.stringify(rule.keyPathValue)})'>
                            üëÅÔ∏è View
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick='deleteRule(${JSON.stringify(rule.keyPathValue)})'>
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
                <div class="rule-title">${content}</div>
                <div class="rule-meta">
                    üë§ Author: <strong>${author}</strong> | üÜî ID: <strong>${id}</strong>
                </div>
                ${logicInfo}
                <div class="rule-meta" style="font-size: 0.8rem; color: #999;">
                    Last modified: ${rule.localTimeString || 'Unknown date'}
                </div>
            `;
            
            return div;
        }

        function filterRules() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const searchStatus = document.getElementById('searchStatus');
            
            // Visual feedback
            searchStatus.textContent = `Searching in ${allRules.length} rules...`;
            searchStatus.style.color = '#007bff';
            
            console.log("=== FILTER DEBUG ===");
            console.log("Search term:", searchTerm);
            console.log("Type filter:", typeFilter);
            console.log("Total rules before filter:", allRules.length);
            
            if (allRules.length === 0) {
                searchStatus.textContent = '‚ö†Ô∏è No rules loaded. Click "Create Sample Data" button below.';
                searchStatus.style.color = '#dc3545';
                console.log("No rules to filter!");
                return;
            }
            
            let filtered = allRules.filter(rule => {
                console.log("Checking rule:", rule.keyPathValue);
                
                // Type filter
                if (typeFilter === 'display' && rule.keyPathValue[0] !== 'trueruleStore') {
                    console.log("  -> Filtered out by type (not display rule)");
                    return false;
                }
                if (typeFilter === 'collection' && rule.keyPathValue[0] !== 'groupruleStore') {
                    console.log("  -> Filtered out by type (not collection)");
                    return false;
                }
                
                // Search filter
                if (searchTerm) {
                    const author = (rule.keyPathValue[2] || '').toLowerCase();
                    const id = (rule.keyPathValue[4] || '').toLowerCase();
                    const content = rule.keyPathValue[0] === 'groupruleStore' 
                        ? (rule.groupruleContent || '').toLowerCase()
                        : (rule.ruleContent || '').toLowerCase();
                    
                    console.log("  -> Author:", author, "| ID:", id, "| Content:", content.substring(0, 30));
                    
                    const matches = author.includes(searchTerm) || id.includes(searchTerm) || content.includes(searchTerm);
                    console.log("  -> Matches search:", matches);
                    
                    if (!matches) {
                        return false;
                    }
                }
                
                console.log("  -> PASSED all filters");
                return true;
            });
            
            console.log("Filtered results:", filtered.length);
            console.log("===================");
            
            // Update status
            if (searchTerm || typeFilter !== 'all') {
                searchStatus.textContent = `Found ${filtered.length} of ${allRules.length} rules`;
                searchStatus.style.color = filtered.length > 0 ? '#28a745' : '#dc3545';
            } else {
                searchStatus.textContent = `Showing all ${allRules.length} rules`;
                searchStatus.style.color = '#666';
            }
            
            displayRules(filtered);
        }

        function refreshList() {
            console.log("Refreshing rule list...");
            loadAllRules();
        }

        function showEmptyState(message) {
            const emptyState = document.getElementById('emptyState');
            emptyState.classList.remove('hidealways');
            document.getElementById('rulesContainer').innerHTML = '';
        }

        function createNewDisplayRule() {
            window.location.href = 'index.html?action=newDisplayRule';
        }

        function createNewCollection() {
            window.location.href = 'createCollection.html';
        }

        function editRule(keyPathValue) {
            console.log("Edit rule:", keyPathValue);
            const type = keyPathValue[0];
            const author = keyPathValue[2];
            const id = keyPathValue[4];
            window.location.href = `editRule.html?action=edit&type=${type}&author=${encodeURIComponent(author)}&id=${encodeURIComponent(id)}`;
        }

        function viewRule(keyPathValue) {
            console.log("View rule:", keyPathValue);
            const type = keyPathValue[0];
            const author = keyPathValue[2];
            const id = keyPathValue[4];
            window.location.href = `editRule.html?action=view&type=${type}&author=${encodeURIComponent(author)}&id=${encodeURIComponent(id)}`;
        }

        function deleteRule(keyPathValue) {
            const author = keyPathValue[2];
            const id = keyPathValue[4];
            const type = keyPathValue[0] === 'groupruleStore' ? 'Collection' : 'Display Rule';
            
            if (confirm(`Are you sure you want to delete this ${type}?\n\nAuthor: ${author}\nID: ${id}`)) {
                console.log("Deleting rule:", keyPathValue);
                
                const database = "authorExcuTrust";
                const databaseOpenRequest = indexedDB.open(database);
                
                databaseOpenRequest.onsuccess = () => {
                    const db = databaseOpenRequest.result;
                    const tx = db.transaction("ruleStore", "readwrite");
                    const store = tx.objectStore("ruleStore");
                    const deleteRequest = store.delete(keyPathValue);
                    
                    deleteRequest.onsuccess = () => {
                        console.log("Rule deleted successfully");
                        alert("Rule deleted successfully!");
                        loadAllRules();
                    };
                    
                    deleteRequest.onerror = (event) => {
                        console.error("Error deleting rule:", event);
                        alert("Error deleting rule");
                    };
                    
                    tx.oncomplete = () => {
                        db.close();
                    };
                };
            }
        }

        function clearAllData() {
            if (!confirm("‚ö†Ô∏è WARNING: This will delete ALL rules and collections from the database!\n\nAre you sure you want to continue?")) {
                return;
            }
            
            console.log("Clearing all data...");
            const database = "authorExcuTrust";
            const databaseOpenRequest = indexedDB.open(database);
            
            databaseOpenRequest.onsuccess = () => {
                const db = databaseOpenRequest.result;
                const tx = db.transaction("ruleStore", "readwrite");
                const store = tx.objectStore("ruleStore");
                const clearRequest = store.clear();
                
                clearRequest.onsuccess = () => {
                    console.log("All data cleared successfully");
                    alert("‚úÖ All data cleared successfully!\n\nYou can now create fresh sample data.");
                    loadAllRules();
                };
                
                clearRequest.onerror = (event) => {
                    console.error("Error clearing data:", event);
                    alert("‚ùå Error clearing data");
                };
                
                tx.oncomplete = () => {
                    db.close();
                };
            };
            
            databaseOpenRequest.onerror = (event) => {
                console.error("Error opening database:", event);
                alert("‚ùå Error opening database");
            };
        }

        function createSampleData() {
            console.log("Creating comprehensive sample data...");
            
            // Create sample authors (20)
            const sampleAuthors = [
                { authorName: "JSM", fullName: "John Smith", email: "john.smith@example.com", description: "Senior Rule Designer" },
                { authorName: "AMK", fullName: "Alice Miller", email: "alice.miller@example.com", description: "Business Analyst" },
                { authorName: "RJP", fullName: "Robert Johnson", email: "robert.j@example.com", description: "System Architect" },
                { authorName: "EMW", fullName: "Emma Wilson", email: "emma.w@example.com", description: "Compliance Manager" },
                { authorName: "DLH", fullName: "David Harris", email: "david.h@example.com", description: "Product Owner" },
                { authorName: "STC", fullName: "Sarah Taylor", email: "sarah.t@example.com", description: "UX Designer" },
                { authorName: "MRB", fullName: "Michael Brown", email: "michael.b@example.com", description: "Technical Lead" },
                { authorName: "LKD", fullName: "Linda Davis", email: "linda.d@example.com", description: "Quality Assurance" },
                { authorName: "JAG", fullName: "James Garcia", email: "james.g@example.com", description: "DevOps Engineer" },
                { authorName: "KMR", fullName: "Karen Martinez", email: "karen.m@example.com", description: "Business Consultant" },
                { authorName: "THL", fullName: "Thomas Lee", email: "thomas.l@example.com", description: "Data Analyst" },
                { authorName: "NPA", fullName: "Nancy Anderson", email: "nancy.a@example.com", description: "Project Manager" },
                { authorName: "CRW", fullName: "Charles White", email: "charles.w@example.com", description: "Security Specialist" },
                { authorName: "BJT", fullName: "Barbara Thompson", email: "barbara.t@example.com", description: "Frontend Developer" },
                { authorName: "PWM", fullName: "Paul Moore", email: "paul.m@example.com", description: "Backend Developer" },
                { authorName: "MJC", fullName: "Maria Clark", email: "maria.c@example.com", description: "Database Admin" },
                { authorName: "GSR", fullName: "George Rodriguez", email: "george.r@example.com", description: "API Developer" },
                { authorName: "DWL", fullName: "Dorothy Lewis", email: "dorothy.l@example.com", description: "Testing Manager" },
                { authorName: "KJW", fullName: "Kenneth Walker", email: "kenneth.w@example.com", description: "Integration Specialist" },
                { authorName: "HMH", fullName: "Helen Hall", email: "helen.h@example.com", description: "Release Manager" }
            ];
            
            // Create 20+ Display Rules
            const sampleRules = [
                // User Authentication & Verification Rules
                { author: "JSM", id: "AGE_OVER_18", content: "User must be 18 years or older" },
                { author: "JSM", id: "EMAIL_VERIFIED", content: "User email must be verified" },
                { author: "AMK", id: "PHONE_VERIFIED", content: "User phone number must be verified" },
                { author: "AMK", id: "TWO_FACTOR_ENABLED", content: "Two-factor authentication must be enabled" },
                { author: "RJP", id: "STRONG_PASSWORD", content: "Password must meet strength requirements" },
                
                // Profile Completeness Rules
                { author: "EMW", id: "PROFILE_COMPLETE", content: "User profile must be 100% complete" },
                { author: "EMW", id: "PHOTO_UPLOADED", content: "Profile photo must be uploaded" },
                { author: "DLH", id: "BIO_FILLED", content: "User biography must be filled in" },
                { author: "DLH", id: "ADDRESS_VERIFIED", content: "User address must be verified" },
                
                // Subscription & Payment Rules
                { author: "STC", id: "ACTIVE_SUBSCRIPTION", content: "User must have an active subscription" },
                { author: "STC", id: "PAYMENT_METHOD_VALID", content: "Valid payment method must be on file" },
                { author: "MRB", id: "PREMIUM_MEMBER", content: "User must be a premium member" },
                { author: "MRB", id: "NO_OUTSTANDING_BALANCE", content: "No outstanding balance on account" },
                
                // Activity & Engagement Rules
                { author: "LKD", id: "LOGGED_IN_LAST_30_DAYS", content: "User logged in within last 30 days" },
                { author: "LKD", id: "MIN_ACTIVITY_SCORE", content: "Minimum activity score of 100 required" },
                { author: "JAG", id: "COMPLETED_ONBOARDING", content: "User completed onboarding process" },
                { author: "JAG", id: "ACCEPTED_TERMS", content: "User accepted latest terms and conditions" },
                
                // Security & Compliance Rules
                { author: "KMR", id: "GDPR_CONSENT", content: "GDPR consent provided by user" },
                { author: "KMR", id: "NO_SUSPICIOUS_ACTIVITY", content: "No suspicious activity detected" },
                { author: "THL", id: "IP_NOT_BLOCKED", content: "User IP address not on blocklist" },
                { author: "THL", id: "ACCOUNT_NOT_SUSPENDED", content: "User account is not suspended" },
                
                // Additional Rules
                { author: "NPA", id: "LOCATION_ALLOWED", content: "User location is in allowed regions" },
                { author: "CRW", id: "DEVICE_TRUSTED", content: "User device is trusted" },
                { author: "BJT", id: "BROWSER_SUPPORTED", content: "Browser version is supported" },
                { author: "PWM", id: "API_ACCESS_GRANTED", content: "API access is granted for user" }
            ];
            
            // Create 20+ Collections
            const sampleCollections = [
                { author: "JSM", id: "BASIC_USER_ACCESS", content: "Basic User Access Requirements", logicType: "all", rules: [["JSM", "AGE_OVER_18"], ["JSM", "EMAIL_VERIFIED"], ["JAG", "ACCEPTED_TERMS"]] },
                { author: "AMK", id: "VERIFIED_USER", content: "Fully Verified User", logicType: "all", rules: [["JSM", "EMAIL_VERIFIED"], ["AMK", "PHONE_VERIFIED"], ["DLH", "ADDRESS_VERIFIED"]] },
                { author: "RJP", id: "SECURITY_CHECKS", content: "Security Verification Checks", logicType: "all", rules: [["RJP", "STRONG_PASSWORD"], ["AMK", "TWO_FACTOR_ENABLED"], ["KMR", "NO_SUSPICIOUS_ACTIVITY"]] },
                { author: "EMW", id: "COMPLETE_PROFILE", content: "Complete User Profile", logicType: "all", rules: [["EMW", "PROFILE_COMPLETE"], ["EMW", "PHOTO_UPLOADED"], ["DLH", "BIO_FILLED"]] },
                { author: "DLH", id: "PREMIUM_ACCESS", content: "Premium Feature Access", logicType: "all", rules: [["MRB", "PREMIUM_MEMBER"], ["STC", "ACTIVE_SUBSCRIPTION"], ["STC", "PAYMENT_METHOD_VALID"]] },
                { author: "STC", id: "ACTIVE_USER", content: "Active Engaged User", logicType: "any", rules: [["LKD", "LOGGED_IN_LAST_30_DAYS"], ["LKD", "MIN_ACTIVITY_SCORE"]] },
                { author: "MRB", id: "PAYMENT_READY", content: "Payment Ready Status", logicType: "all", rules: [["STC", "PAYMENT_METHOD_VALID"], ["MRB", "NO_OUTSTANDING_BALANCE"]] },
                { author: "LKD", id: "ONBOARDING_COMPLETE", content: "Onboarding Completion", logicType: "all", rules: [["JAG", "COMPLETED_ONBOARDING"], ["JAG", "ACCEPTED_TERMS"], ["EMW", "PROFILE_COMPLETE"]] },
                { author: "JAG", id: "COMPLIANCE_MET", content: "Compliance Requirements Met", logicType: "all", rules: [["KMR", "GDPR_CONSENT"], ["JAG", "ACCEPTED_TERMS"], ["THL", "ACCOUNT_NOT_SUSPENDED"]] },
                { author: "KMR", id: "TRUSTED_USER", content: "Trusted User Status", logicType: "all", rules: [["KMR", "NO_SUSPICIOUS_ACTIVITY"], ["THL", "IP_NOT_BLOCKED"], ["CRW", "DEVICE_TRUSTED"]] },
                { author: "THL", id: "FULL_ACCESS", content: "Full Platform Access", logicType: "all", rules: [["JSM", "AGE_OVER_18"], ["AMK", "PHONE_VERIFIED"], ["MRB", "PREMIUM_MEMBER"]] },
                { author: "NPA", id: "REGIONAL_ACCESS", content: "Regional Access Requirements", logicType: "all", rules: [["NPA", "LOCATION_ALLOWED"], ["THL", "IP_NOT_BLOCKED"]] },
                { author: "CRW", id: "SECURITY_CLEARANCE", content: "Security Clearance Level", logicType: "all", rules: [["CRW", "DEVICE_TRUSTED"], ["AMK", "TWO_FACTOR_ENABLED"], ["KMR", "NO_SUSPICIOUS_ACTIVITY"]] },
                { author: "BJT", id: "TECH_REQUIREMENTS", content: "Technical Requirements Met", logicType: "all", rules: [["BJT", "BROWSER_SUPPORTED"], ["CRW", "DEVICE_TRUSTED"]] },
                { author: "PWM", id: "API_READY", content: "API Access Ready", logicType: "all", rules: [["PWM", "API_ACCESS_GRANTED"], ["THL", "ACCOUNT_NOT_SUSPENDED"]] },
                { author: "MJC", id: "ADVANCED_FEATURES", content: "Advanced Features Access", logicType: "count", minCount: 3, rules: [["MRB", "PREMIUM_MEMBER"], ["LKD", "MIN_ACTIVITY_SCORE"], ["EMW", "PROFILE_COMPLETE"], ["AMK", "TWO_FACTOR_ENABLED"]] },
                { author: "GSR", id: "PARTIAL_ACCESS", content: "Partial Access Grant", logicType: "any", rules: [["JSM", "EMAIL_VERIFIED"], ["AMK", "PHONE_VERIFIED"]] },
                { author: "DWL", id: "QUALITY_USER", content: "Quality User Status", logicType: "percent", minPercent: 75, rules: [["LKD", "MIN_ACTIVITY_SCORE"], ["EMW", "PROFILE_COMPLETE"], ["AMK", "PHONE_VERIFIED"], ["DLH", "BIO_FILLED"]] },
                { author: "KJW", id: "INTEGRATION_READY", content: "Integration Ready Status", logicType: "all", rules: [["PWM", "API_ACCESS_GRANTED"], ["CRW", "DEVICE_TRUSTED"], ["JAG", "COMPLETED_ONBOARDING"]] },
                { author: "HMH", id: "PRODUCTION_READY", content: "Production Ready User", logicType: "all", rules: [["JAG", "ACCEPTED_TERMS"], ["KMR", "GDPR_CONSENT"], ["THL", "ACCOUNT_NOT_SUSPENDED"]] },
                { author: "JSM", id: "VIP_ACCESS", content: "VIP User Access", logicType: "all", rules: [["MRB", "PREMIUM_MEMBER"], ["LKD", "MIN_ACTIVITY_SCORE"], ["EMW", "PROFILE_COMPLETE"], ["AMK", "TWO_FACTOR_ENABLED"]] }
            ];

            const database = "authorExcuTrust";
            const databaseOpenRequest = indexedDB.open(database);
            
            databaseOpenRequest.onsuccess = () => {
                const db = databaseOpenRequest.result;
                
                console.log("Database stores available:", Array.from(db.objectStoreNames));
                
                // Check which stores exist
                const hasRuleStore = db.objectStoreNames.contains("ruleStore");
                const hasAuthorStore = db.objectStoreNames.contains("authorMetadata");
                
                console.log("Has ruleStore:", hasRuleStore);
                console.log("Has authorMetadata:", hasAuthorStore);
                
                if (!hasRuleStore) {
                    alert("‚ùå Database not properly initialized. Please refresh the page.");
                    db.close();
                    return;
                }
                
                // Clear existing data from stores that exist
                const storesToClear = hasAuthorStore ? ["ruleStore", "authorMetadata"] : ["ruleStore"];
                const clearTx = db.transaction(storesToClear, "readwrite");
                const clearRuleStore = clearTx.objectStore("ruleStore");
                
                clearRuleStore.clear();
                
                if (hasAuthorStore) {
                    const clearAuthorStore = clearTx.objectStore("authorMetadata");
                    clearAuthorStore.clear();
                }
                
                clearTx.oncomplete = () => {
                    console.log("Cleared old data, now adding sample data...");
                    
                    // Add authors if the store exists
                    if (hasAuthorStore) {
                        const authorTx = db.transaction("authorMetadata", "readwrite");
                        const authorStore = authorTx.objectStore("authorMetadata");
                        
                        sampleAuthors.forEach(author => {
                            const authorData = {
                                authorName: author.authorName,
                                fullName: author.fullName,
                                email: author.email,
                                description: author.description,
                                createdDate: Date.now(),
                                modifiedDate: Date.now()
                            };
                            authorStore.add(authorData);
                        });
                        
                        authorTx.oncomplete = () => {
                            console.log(`Added ${sampleAuthors.length} authors to authorMetadata store`);
                            addRulesAndCollections(db, sampleRules, sampleCollections, sampleAuthors);
                        };
                        
                        authorTx.onerror = (event) => {
                            console.error("Error adding authors:", event);
                            alert("‚ùå Error adding authors");
                            db.close();
                        };
                    } else {
                        console.warn("authorMetadata store doesn't exist, skipping author creation");
                        addRulesAndCollections(db, sampleRules, sampleCollections, sampleAuthors);
                    }
                };
                
                clearTx.onerror = (event) => {
                    console.error("Error clearing old data:", event);
                    db.close();
                    alert("‚ùå Error clearing old data. Please refresh the page and try again.");
                };
            };
            
            databaseOpenRequest.onerror = (event) => {
                console.error("Error opening database:", event);
                alert("‚ùå Error opening database");
            };
        }
        
        function addRulesAndCollections(db, sampleRules, sampleCollections, sampleAuthors) {
            // Now add display rules and collections
            const ruleTx = db.transaction("ruleStore", "readwrite");
            const ruleStore = ruleTx.objectStore("ruleStore");
            
            let rulesAdded = 0;
            sampleRules.forEach(rule => {
                const ruleData = {
                    keyPathValue: ["trueruleStore", 1, rule.author, 1, rule.id],
                    ruleContent: rule.content,
                    ruleContentInnerText: rule.content,
                    ruleAuthor: rule.author,
                    ruleID: rule.id,
                    versionDateSince1969: Date.now(),
                    localTimeString: new Date().toString()
                };
                ruleStore.add(ruleData);
                rulesAdded++;
            });
            
            // Add collections
            sampleCollections.forEach(collection => {
                const collectionData = {
                    keyPathValue: ["groupruleStore", 1, collection.author, 1, collection.id],
                    groupruleContent: collection.content,
                    groupruleContentInnerText: collection.content,
                    groupruleAuthor: collection.author,
                    groupruleID: collection.id,
                    ruleLogicType: collection.logicType,
                    minRuleCount: collection.minCount || 1,
                    minRulePercent: collection.minPercent || 50,
                    all0Any1True: collection.logicType === 'any',
                    allRowChoices: [],
                    allArrayType: collection.rules.map(() => "trueruleStore"),
                    allArrayAuthor: collection.rules.map(r => r[0]),
                    allArrayID: collection.rules.map(r => r[1]),
                    versionDateSince1969: Date.now(),
                    localTimeString: new Date().toString()
                };
                ruleStore.add(collectionData);
            });
            
            ruleTx.oncomplete = () => {
                console.log(`Sample data creation complete!`);
                db.close();
                alert(`‚úÖ Created comprehensive sample data!\n\n` +
                    `üìä Statistics:\n` +
                    `‚Ä¢ ${sampleAuthors.length} Authors\n` +
                    `‚Ä¢ ${sampleRules.length} Display Rules\n` +
                    `‚Ä¢ ${sampleCollections.length} Collections\n` +
                    `‚Ä¢ Total: ${sampleAuthors.length + sampleRules.length + sampleCollections.length} records\n\n` +
                    `You can now view and manage all these items!`);
                loadAllRules();
            };
            
            ruleTx.onerror = (event) => {
                console.error("Error adding rules:", event);
                alert("‚ùå Error adding rules");
                db.close();
            };
        }
    </script>
</body>
</html>
